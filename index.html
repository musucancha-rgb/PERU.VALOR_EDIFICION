<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Calculadora - Valor de la Edificación</title>
  
  <!-- METADATOS PARA COMPORTAMIENTO NATIVO (APP) -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#1e293b" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <!-- Iconos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* RESET Y ESTILOS BASE PARA MÓVIL */
    body { 
        font-family: 'Inter', sans-serif; 
        overscroll-behavior-y: none; /* Previene el rebote en iOS */
        user-select: none; /* Sensación de App nativa */
        -webkit-tap-highlight-color: transparent;
    }

    /* Permitir selección solo en inputs */
    input, select { user-select: text; }
    
    .custom-scroll::-webkit-scrollbar { width: 4px; }
    .custom-scroll::-webkit-scrollbar-track { background: transparent; }
    .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
    
    #map { z-index: 0; height: 100vh; width: 100vw; position: fixed; top: 0; left: 0; }
    
    /* Panel Flotante Estilo Drawer */
    .panel-hidden { transform: translateY(100%); opacity: 0; pointer-events: none; }
    .panel-visible { transform: translateY(0); opacity: 1; pointer-events: auto; }
    
    /* En Desktop mantenemos el panel lateral, en móvil es un Bottom Sheet */
    @media (min-width: 768px) {
        .panel-hidden { transform: translateX(-100%); }
        .panel-visible { transform: translateX(0); }
    }
    
    /* Inputs amigables para dedos */
    select, input {
        font-size: 16px !important; /* Evita zoom automático en iOS al enfocar */
    }
  </style>
</head>

<body class="bg-gray-100 overflow-hidden relative h-screen w-screen">

  <!-- BOTÓN FLOTANTE (MÓVIL) - CENTRADO ABAJO -->
  <button id="mobileToggleBtn" class="md:hidden absolute bottom-6 left-1/2 transform -translate-x-1/2 z-[2000] bg-blue-600 text-white w-16 h-16 rounded-full shadow-2xl flex items-center justify-center hover:bg-blue-700 active:scale-90 transition-all duration-200 ring-4 ring-white/30">
    <i class="fa-solid fa-calculator text-2xl"></i>
  </button>

  <!-- BOTÓN LATERAL (DESKTOP) -->
  <button id="toggleSideBtn" class="hidden md:flex absolute left-0 top-1/2 transform -translate-y-1/2 z-[2000] bg-white text-blue-700 w-8 h-20 rounded-r-xl shadow-xl border-y border-r border-gray-300 items-center justify-center hover:bg-blue-50 transition-all duration-300">
    <i id="toggleIcon" class="fa-solid fa-chevron-left text-lg"></i>
  </button>

  <!-- CONTENEDOR UI -->
  <div id="uiContainer" class="absolute inset-0 z-[1000] pointer-events-none flex flex-col justify-end md:justify-start items-center md:items-stretch transition-all duration-300 md:p-4 md:w-[500px]">
    
    <!-- PANEL PRINCIPAL (BOTTOM SHEET EN MÓVIL / SIDEBAR EN DESKTOP) -->
    <div id="mainPanel" class="panel-visible pointer-events-auto bg-white/95 backdrop-blur-md shadow-[0_-10px_40px_rgba(0,0,0,0.2)] md:shadow-2xl rounded-t-3xl md:rounded-2xl flex flex-col w-full h-[90vh] md:h-[98%] border-t border-white/20 overflow-hidden transition-all duration-500 ease-in-out">
      
      <!-- BARRA DE ARRASTRE (VISUAL MÓVIL) -->
      <div class="md:hidden w-full flex justify-center pt-3 pb-1" onclick="togglePanel()">
        <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
      </div>

      <!-- HEADER -->
      <div class="bg-slate-50/80 p-4 border-b border-gray-200 shrink-0">
        <div class="flex justify-between items-start">
            <div>
                <div class="flex items-center gap-2 mb-1">
                    <div class="bg-blue-600 text-white p-1 rounded">
                        <i class="fa-solid fa-calculator text-xs"></i>
                    </div>
                    <span class="text-[10px] font-bold text-blue-600 uppercase tracking-wider">R.M. N° 172-2016</span>
                </div>
                <!-- NUEVA JERARQUÍA DE TÍTULO -->
                <h1 class="text-2xl font-extrabold text-slate-800 leading-none mb-0.5">Calculadora</h1>
                <h2 class="text-lg font-bold text-slate-600 leading-tight">Valor de la edificación</h2>
                
                <p id="selectedDistrictDisplay" class="text-xs text-blue-600 font-semibold mt-2 truncate max-w-[250px]"><i class="fa-solid fa-location-dot mr-1"></i> Selecciona zona en mapa</p>
            </div>
            
            <div class="flex gap-2">
                 <button onclick="resetCalculator()" class="text-xs text-red-500 bg-red-50 p-2 rounded-lg border border-red-100 active:bg-red-100 transition-colors" title="Reiniciar">
                    <i class="fa-solid fa-rotate-right"></i>
                </button>
                <!-- Botón cerrar solo móvil -->
                <button onclick="togglePanel()" class="md:hidden text-xs text-slate-500 bg-slate-100 p-2 rounded-lg border border-slate-200 active:bg-slate-200 transition-colors">
                    <i class="fa-solid fa-chevron-down"></i>
                </button>
            </div>
        </div>
        
        <!-- SELECTOR DE REGIÓN -->
        <div class="mt-3">
            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Región Tarifaria</label>
            <select id="regionSelect" onchange="updateRegion()" class="block w-full mt-1 p-3 bg-white border border-slate-300 rounded-xl text-sm font-semibold text-slate-700 shadow-sm focus:border-blue-500 outline-none appearance-none">
                <option value="lima">Lima Metropolitana y Callao</option>
                <option value="costa">Costa (Excl. Lima/Callao)</option>
                <option value="sierra">Sierra</option>
                <option value="selva">Selva</option>
            </select>
        </div>
      </div>

      <!-- BODY SCROLLABLE -->
      <div class="flex-1 overflow-y-auto custom-scroll p-4 space-y-6 pb-40 md:pb-32">

        <!-- 1. DATOS GENERALES -->
        <section class="space-y-3 bg-white p-3 rounded-xl border border-slate-100 shadow-sm">
            <h3 class="text-sm font-bold text-slate-700 border-b pb-1">1. Datos Básicos</h3>
            <!-- FORMULARIO ALINEADO VERTICALMENTE (1 COLUMNA) -->
            <div class="flex flex-col gap-3">
                <div>
                    <label class="text-xs text-slate-500 font-semibold mb-1 block">Material Predominante</label>
                    <select id="materialSelect" class="w-full p-2 bg-slate-50 border rounded-lg text-sm h-10">
                        <option value="concreto">Concreto</option>
                        <option value="ladrillo">Ladrillo</option>
                        <option value="adobe">Adobe/Quincha</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs text-slate-500 font-semibold mb-1 block">Estado de Conservación</label>
                    <select id="estadoSelect" class="w-full p-2 bg-slate-50 border rounded-lg text-sm h-10">
                        <option value="muy_bueno">Muy Bueno</option>
                        <option value="bueno">Bueno</option>
                        <option value="regular">Regular</option>
                        <option value="malo">Malo</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs text-slate-500 font-semibold mb-1 block">Antigüedad (Años)</label>
                    <input type="number" id="antiguedadInput" value="0" min="0" class="w-full p-2 bg-slate-50 border rounded-lg text-sm text-right h-10">
                </div>
                <div>
                    <label class="text-xs text-slate-500 font-bold mb-1 block">Área Techada Total (m²)</label>
                    <input type="number" id="areaInput" value="100" min="1" class="w-full p-2 bg-blue-50 border border-blue-200 rounded-lg text-sm font-bold text-right text-blue-800 h-10">
                </div>
            </div>
            
            <div class="bg-yellow-50 p-2 rounded-lg border border-yellow-200 flex justify-between items-center mt-2">
                <span class="text-xs text-yellow-800"><i class="fa-solid fa-arrow-trend-down mr-1"></i> Depreciación</span>
                <span id="deprecDisplay" class="text-sm font-bold text-yellow-900">0%</span>
            </div>
        </section>

        <!-- 2. CATEGORÍAS -->
        <section class="space-y-3 bg-white p-3 rounded-xl border border-slate-100 shadow-sm">
            <div class="flex justify-between items-end border-b pb-1">
                <h3 class="text-sm font-bold text-slate-700">2. Componentes (S/m²)</h3>
            </div>
            
            <div id="categoriesContainer" class="space-y-3 text-sm">
                <!-- Dinámico -->
            </div>

            <div class="flex justify-between items-center bg-slate-100 p-3 rounded-lg">
                <span class="font-semibold text-slate-600 text-xs">Valor Unitario</span>
                <span id="valorUnitarioTotal" class="font-bold text-slate-800 text-lg">0.00</span>
            </div>
        </section>

        <!-- 3. OBRAS COMPLEMENTARIAS -->
        <section class="space-y-3 bg-white p-3 rounded-xl border border-slate-100 shadow-sm">
            <!-- NUEVO TÍTULO PARA LISTA -->
            <h3 class="text-sm font-bold text-slate-700 border-b pb-1">3. Valores unitarios a costo directo</h3>
            
            <div class="flex flex-col gap-2">
                <select id="obrasSelect" class="w-full p-2 bg-slate-50 border rounded-lg text-xs h-10">
                    <!-- Dinámico -->
                </select>
                <div class="flex gap-2">
                    <input type="number" id="obraQty" placeholder="Cant." class="w-20 p-2 border rounded-lg text-xs text-center h-10">
                    <button onclick="addObra()" class="flex-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 h-10 font-bold text-sm active:scale-95 transition-transform">
                        <i class="fa-solid fa-plus mr-1"></i> Agregar
                    </button>
                </div>
            </div>

            <div id="obrasList" class="space-y-2 max-h-48 overflow-y-auto custom-scroll border border-slate-100 rounded-lg bg-gray-50 p-1 min-h-[50px]">
                <div class="text-center py-4 text-xs text-slate-400 italic" id="emptyObrasMsg">Sin obras adicionales</div>
            </div>
        </section>

        <!-- BOTÓN CALCULAR (NUEVO) -->
        <button onclick="calculate()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg transform active:scale-95 transition-all text-lg flex items-center justify-center gap-2 mb-4">
            <i class="fa-solid fa-calculator"></i> CALCULAR VALOR EDIFICACIÓN
        </button>

      </div>

      <!-- FOOTER TOTALES -->
      <div class="p-4 bg-slate-800 text-white shrink-0 shadow-[0_-5px_15px_rgba(0,0,0,0.2)] z-10 pb-6 md:pb-4">
        
        <!-- SUBTOTALES DESGLOSADOS -->
        <div class="space-y-1 mb-3">
            <div class="flex justify-between items-center text-[11px] text-slate-400">
                <span>1. Subtotal del Valor unitario oficial de edificación:</span>
                <span id="subtotalEdif" class="font-mono">S/. 0.00</span>
            </div>
            <div class="flex justify-between items-center text-[11px] text-slate-400">
                <span>2. Subtotal del valor unitarios a costo directo:</span>
                <span id="subtotalObras" class="font-mono">S/. 0.00</span>
            </div>
        </div>
        
        <div class="border-t border-slate-600 my-2"></div>
        
        <!-- TOTAL EDIFICACIÓN -->
        <div class="flex justify-between items-end mb-5">
            <div>
                <p class="text-[10px] uppercase tracking-widest text-slate-300 font-bold">Valor de la Edificación</p>
                <p id="totalFinal" class="text-2xl font-bold leading-none text-green-400">S/. 0.00</p>
            </div>
        </div>

        <!-- SECCIÓN CÁLCULO PREDIO (NUEVA FÓRMULA) -->
        <div class="bg-slate-700/50 p-3 rounded-lg border border-slate-600 mb-4">
            <h4 class="text-sm font-bold text-orange-400 mb-2">¿Quieres obtener el valor total del predio?</h4>
            
            <!-- FÓRMULA VISUAL -->
            <div class="flex items-end gap-2 mb-2 text-xs">
                <div class="flex-1">
                    <label class="text-[9px] text-slate-400 block mb-1">V. Terreno (completar)</label>
                    <input type="number" id="valorTerrenoInput" placeholder="0.00" class="w-full p-2 rounded bg-white text-slate-900 font-bold focus:outline-none focus:ring-2 focus:ring-orange-500 text-right" oninput="calculatePredio()">
                </div>
                <div class="text-slate-400 font-bold pb-2">+</div>
                <div class="flex-1">
                    <label class="text-[9px] text-slate-400 block mb-1">V. Edificación (auto)</label>
                    <div id="displayEdificacionAuto" class="w-full p-2 rounded bg-slate-600 text-slate-300 font-bold text-right border border-slate-500">
                        0.00
                    </div>
                </div>
            </div>

            <!-- RESULTADO PREDIO -->
            <div class="flex justify-between items-center mt-3 bg-orange-500/20 p-2 rounded border border-orange-500/50">
                <span class="text-xs font-bold text-orange-200">V. PREDIO TOTAL:</span>
                <span id="valorPredioTotal" class="text-lg font-bold text-white">S/. 0.00</span>
            </div>
            
            <!-- LINK ARANCELARIO -->
            <div class="mt-2 text-right">
                 <a href="https://musucancha-rgb.github.io/mapa-mef-2026/" target="_blank" class="text-blue-300 hover:text-white text-[10px] inline-flex items-center gap-1 bg-slate-800 px-2 py-1 rounded border border-slate-600">
                    <i class="fa-solid fa-map-location-dot"></i> Consultar Valor Arancelario 2026
                </a>
            </div>
        </div>
        
        <!-- CREDITOS -->
        <div class="mt-4 pt-3 border-t border-slate-700 flex flex-col items-center gap-2">
            <span class="text-[10px] font-bold text-slate-400">Elaborado por Lab Urban Risk</span>
            <div class="flex gap-6 text-sm">
                <!-- YouTube (Rojo) -->
                <a href="https://youtube.com/@laburbanrisk" target="_blank" class="text-red-500 hover:text-red-400 transform hover:scale-110">
                    <i class="fa-brands fa-youtube fa-lg"></i>
                </a>
                <!-- Facebook (Azul) -->
                <a href="https://www.facebook.com/share/1Db3ZgmTE4/?mibextid=wwXIfr" target="_blank" class="text-blue-500 hover:text-blue-400 transform hover:scale-110">
                    <i class="fa-brands fa-facebook fa-lg"></i>
                </a>
                <!-- Instagram (Rosa) -->
                <a href="https://www.instagram.com/laburbanrisk?igsh=MWNzam53enpzZng4Ng%3D%3D&utm_source=qr" target="_blank" class="text-pink-500 hover:text-pink-400 transform hover:scale-110">
                    <i class="fa-brands fa-instagram fa-lg"></i>
                </a>
                <!-- TikTok (Blanco) -->
                <a href="https://www.tiktok.com/@laburbanrisk?_r=1&_t=ZN-92idJVeblZe" target="_blank" class="text-white hover:text-gray-300 transform hover:scale-110">
                    <i class="fa-brands fa-tiktok fa-lg"></i>
                </a>
            </div>
        </div>
        
      </div>

    </div>
  </div>

  <!-- MAPA -->
  <div id="map"></div>

  <!-- LEAFLET JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // --- 0. GESTIÓN DE ESTADO (PERSISTENCIA DE DATOS) ---
    function saveState() {
        const state = {
            region: document.getElementById('regionSelect').value,
            material: document.getElementById('materialSelect').value,
            estado: document.getElementById('estadoSelect').value,
            antiguedad: document.getElementById('antiguedadInput').value,
            area: document.getElementById('areaInput').value,
            valorTerreno: document.getElementById('valorTerrenoInput').value, 
            obras: currentObras
        };
        localStorage.setItem('calcState', JSON.stringify(state));
    }

    function loadState() {
        const saved = localStorage.getItem('calcState');
        if (saved) {
            try {
                const state = JSON.parse(saved);
                document.getElementById('regionSelect').value = state.region || 'lima';
                document.getElementById('materialSelect').value = state.material || 'concreto';
                document.getElementById('estadoSelect').value = state.estado || 'muy_bueno';
                document.getElementById('antiguedadInput').value = state.antiguedad || 0;
                document.getElementById('areaInput').value = state.area || 100;
                document.getElementById('valorTerrenoInput').value = state.valorTerreno || ''; 
                currentObras = state.obras || [];
                return true;
            } catch (e) { console.error("Error loading state", e); }
        }
        return false;
    }

    // --- 1. DATA MASTER ---
    const MASTER_OBRAS_LIST = [
        {id: 1, name: "Muro concreto armado, e=0.25m h=2.40m", unit: "m2", prices: {lima: 453.45, costa: 443.89, sierra: 444.14, selva: 457.72}},
        {id: 2, name: "Muro traslúcido (tipo UNI) / metálico h=2.40m", unit: "m2", prices: {lima: 417.73, costa: 408.92, sierra: 409.15, selva: 421.66}},
        {id: 3, name: "Muro ladrillo tarrajeado, col. concreto h>2.40m", unit: "m2", prices: {lima: 383.77, costa: 375.68, sierra: 375.89, selva: 387.38}},
        {id: 4, name: "Muro ladrillo tarrajeado, col. concreto h<=2.40m", unit: "m2", prices: {lima: 336.07, costa: 328.99, sierra: 329.17, selva: 339.24}},
        {id: 5, name: "Muro ladrillo solaqueado, col. concreto h<=2.40m", unit: "m2", prices: {lima: 281.01, costa: 275.09, sierra: 275.24, selva: 283.66}},
        {id: 6, name: "Cerco de fierro/aluminio", unit: "m2", prices: {lima: 206.30, costa: 201.95, sierra: 202.06, selva: 208.24}},
        {id: 7, name: "Muro ladrillo soga, cimentación", unit: "m2", prices: {lima: 235.30, costa: 230.34, sierra: 230.47, selva: 237.52}},
        {id: 8, name: "Muro adobe, tapial o quincha tarrajeado", unit: "m2", prices: {lima: 150.76, costa: 147.58, sierra: 147.66, selva: 152.18}},
        {id: 9, name: "Muro ladrillo cabeza, col. concreto h<=2.40m", unit: "m2", prices: {lima: 408.56, costa: 399.95, sierra: 400.17, selva: 412.41}},
        {id: 10, name: "Puerta fierro/aluminio h=2.20m ancho<=2.00m", unit: "m2", prices: {lima: 618.00, costa: 604.98, sierra: 605.31, selva: 623.83}},
        {id: 11, name: "Puerta fierro plancha h=2.20m ancho>2.00m", unit: "m2", prices: {lima: 590.41, costa: 577.96, sierra: 578.28, selva: 595.97}},
        {id: 12, name: "Portón fierro plancha h>3.00m hasta 4.00m", unit: "m2", prices: {lima: 427.48, costa: 418.47, sierra: 418.70, selva: 468.54}},
        {id: 13, name: "Puerta madera h=2.20m ancho<=2.00m", unit: "m2", prices: {lima: 449.15, costa: 439.68, sierra: 439.92, selva: 483.88}},
        {id: 14, name: "Puerta madera h=2.20m ancho>2.00m", unit: "m2", prices: {lima: 404.21, costa: 395.68, sierra: 395.90, selva: 435.47}},
        {id: 15, name: "Portón fierro plancha h<=3.00m", unit: "m2", prices: {lima: 360.87, costa: 353.26, sierra: 353.46, selva: 394.83}},
        {id: 16, name: "Portón fierro plancha h>4.00m", unit: "m2", prices: {lima: 321.02, costa: 314.25, sierra: 314.43, selva: 351.30}},
        {id: 17, name: "Tanque elevado concreto <= 5m3", unit: "m3", prices: {lima: 1316.09, costa: 1288.35, sierra: 1289.07, selva: 1328.49}},
        {id: 18, name: "Tanque elevado plástico/fibra > 1m3", unit: "m3", prices: {lima: 1439.21, costa: 1408.88, sierra: 1409.66, selva: 1452.77}},
        {id: 19, name: "Tanque elevado concreto > 5m3", unit: "m3", prices: {lima: 1103.04, costa: 1079.79, sierra: 1080.39, selva: 1113.43}},
        {id: 20, name: "Tanque elevado concreto > 15m3", unit: "m3", prices: {lima: 977.16, costa: 956.56, sierra: 957.09, selva: 986.37}},
        {id: 21, name: "Tanque elevado plástico/fibra <= 1m3", unit: "m3", prices: {lima: 1083.70, costa: 1060.86, sierra: 1061.45, selva: 1093.91}},
        {id: 22, name: "Cisterna plástico/fibra > 1m3", unit: "m3", prices: {lima: 1483.42, costa: 1452.15, sierra: 1452.95, selva: 1497.39}},
        {id: 23, name: "Cisterna concreto <= 5m3", unit: "m3", prices: {lima: 1488.89, costa: 1457.50, sierra: 1458.31, selva: 1502.91}},
        {id: 24, name: "Cisterna concreto <= 10m3", unit: "m3", prices: {lima: 1241.37, costa: 1215.21, sierra: 1215.88, selva: 1253.07}},
        {id: 25, name: "Cisterna concreto <= 20m3", unit: "m3", prices: {lima: 1092.61, costa: 1069.58, sierra: 1070.17, selva: 1102.90}},
        {id: 26, name: "Cisterna, pozo ladrillo tarrajeado <= 5m3", unit: "m3", prices: {lima: 1176.91, costa: 1152.10, sierra: 1152.74, selva: 1188.00}},
        {id: 27, name: "Cisterna concreto > 20m3", unit: "m3", prices: {lima: 901.92, costa: 882.91, sierra: 883.40, selva: 910.42}},
        {id: 28, name: "Tanque plástico/fibra <= 1m3", unit: "m3", prices: {lima: 904.36, costa: 885.30, sierra: 885.79, selva: 912.88}},
        {id: 29, name: "Piscina concreto c/mayólica <= 5m3", unit: "m3", prices: {lima: 1483.41, costa: 1452.14, sierra: 1452.94, selva: 1497.38}},
        {id: 30, name: "Piscina concreto c/mayólica <= 10m3", unit: "m3", prices: {lima: 1236.70, costa: 1210.63, sierra: 1211.30, selva: 1248.35}},
        {id: 31, name: "Piscina concreto c/mayólica > 10m3", unit: "m3", prices: {lima: 1182.92, costa: 1157.99, sierra: 1158.63, selva: 1194.07}},
        {id: 32, name: "Piscina ladrillo KK c/pintura", unit: "m3", prices: {lima: 1019.30, costa: 997.81, sierra: 998.37, selva: 1028.90}},
        {id: 33, name: "Losa concreto armado e=4\"", unit: "m2", prices: {lima: 170.50, costa: 166.91, sierra: 167.00, selva: 172.11}},
        {id: 34, name: "Asfalto e=2\"", unit: "m2", prices: {lima: 141.85, costa: 138.86, sierra: 138.93, selva: 143.18}},
        {id: 35, name: "Losa concreto simple e=4\"", unit: "m2", prices: {lima: 136.11, costa: 133.25, sierra: 133.32, selva: 137.40}},
        {id: 36, name: "Vereda concreto e=4\"", unit: "m2", prices: {lima: 107.31, costa: 105.05, sierra: 105.10, selva: 108.32}},
        {id: 37, name: "Horno concreto armado/refractario", unit: "m3", prices: {lima: 1596.70, costa: 1563.04, sierra: 1563.91, selva: 1611.74}},
        {id: 38, name: "Horno ladrillo/refractario", unit: "m3", prices: {lima: 1346.81, costa: 1318.42, sierra: 1319.15, selva: 1359.50}},
        {id: 39, name: "Horno adobe", unit: "m3", prices: {lima: 402.14, costa: 393.67, sierra: 393.88, selva: 405.93}},
        {id: 40, name: "Torre de vigilancia (concreto)", unit: "und", prices: {lima: 7081.57, costa: 6932.30, sierra: 6936.14, selva: 7148.29}},
        {id: 41, name: "Estructura concreto (sin torre)", unit: "und", prices: {lima: 4208.44, costa: 4119.73, sierra: 4122.01, selva: 4248.09}},
        {id: 42, name: "Bóveda concreto armado reforzado", unit: "m3", prices: {lima: 1529.53, costa: 1497.29, sierra: 1498.12, selva: 1543.94}},
        {id: 43, name: "Balanza industrial concreto", unit: "m3", prices: {lima: 869.64, costa: 851.31, sierra: 851.78, selva: 877.84}},
        {id: 44, name: "Poste concreto/fierro con reflector", unit: "und", prices: {lima: 2583.43, costa: 2528.97, sierra: 2530.37, selva: 2607.76}},
        {id: 45, name: "Dados concreto (soporte máquinas)", unit: "m3", prices: {lima: 1808.83, costa: 1770.71, sierra: 1771.69, selva: 1825.88}},
        {id: 46, name: "Caja registro 24\"x24\"", unit: "und", prices: {lima: 342.64, costa: 335.41, sierra: 335.60, selva: 345.86}},
        {id: 47, name: "Caja registro 12\"x24\"", unit: "und", prices: {lima: 332.67, costa: 325.66, sierra: 325.84, selva: 335.80}},
        {id: 48, name: "Caja registro 10\"x20\"", unit: "und", prices: {lima: 284.29, costa: 278.30, sierra: 278.46, selva: 286.97}},
        {id: 49, name: "Buzón de concreto standard", unit: "und", prices: {lima: 2518.08, costa: 2465.00, sierra: 2466.37, selva: 2541.80}},
        {id: 50, name: "Parapeto ladrillo cabeza tarrajeado", unit: "m2", prices: {lima: 243.42, costa: 238.29, sierra: 238.42, selva: 245.71}},
        {id: 51, name: "Parapeto ladrillo soga tarrajeado", unit: "m2", prices: {lima: 197.06, costa: 192.91, sierra: 193.01, selva: 198.92}},
        {id: 52, name: "Parapeto ladrillo cabeza caravista", unit: "m2", prices: {lima: 169.09, costa: 165.52, sierra: 180.02, selva: 170.68}},
        {id: 53, name: "Parapeto ladrillo soga caravista", unit: "m2", prices: {lima: 111.12, costa: 108.78, sierra: 108.84, selva: 112.17}},
        {id: 54, name: "Escalera concreto armado c/acabados", unit: "m3", prices: {lima: 6133.92, costa: 6004.63, sierra: 6007.96, selva: 6191.71}},
        {id: 55, name: "Escalera concreto armado s/acabados", unit: "m3", prices: {lima: 4954.27, costa: 4849.84, sierra: 4852.53, selva: 5000.95}},
        {id: 56, name: "Rampa/Grada concreto c/encofrado", unit: "m3", prices: {lima: 2126.08, costa: 2081.27, sierra: 2082.42, selva: 2146.11}},
        {id: 57, name: "Rampa concreto s/encofrado", unit: "m3", prices: {lima: 1735.70, costa: 1699.11, sierra: 1700.05, selva: 1752.05}},
        {id: 58, name: "Muro contención concreto h=1.40m e=20cm", unit: "m3", prices: {lima: 1516.06, costa: 1484.10, sierra: 1484.92, selva: 1530.34}},
        {id: 59, name: "Muro contención concreto h=2.50m e=20cm", unit: "m3", prices: {lima: 1345.55, costa: 1317.19, sierra: 1317.92, selva: 1358.23}},
        {id: 60, name: "Muro contención concreto h=4.00m e=20cm", unit: "m3", prices: {lima: 1317.51, costa: 1289.74, sierra: 1290.45, selva: 1329.92}},
        {id: 61, name: "Muro contención concreto h=1.40m e=15cm", unit: "m3", prices: {lima: 1313.51, costa: 1285.82, sierra: 1286.53, selva: 1325.88}},
        {id: 62, name: "Muro contención concreto h=2.50m e=15cm", unit: "m3", prices: {lima: 1125.98, costa: 1102.24, sierra: 1102.86, selva: 1136.59}},
        {id: 63, name: "Muro contención concreto h=4.00m e=15cm", unit: "m3", prices: {lima: 1091.29, costa: 1068.29, sierra: 1068.88, selva: 1101.58}},
        {id: 64, name: "Escalera caracol metálica h=6.00m", unit: "und", prices: {lima: 9041.42, costa: 8850.84, sierra: 8855.75, selva: 9126.61}},
        {id: 65, name: "Escalera caracol metálica h=3.00m", unit: "und", prices: {lima: 4749.91, costa: 4649.79, sierra: 4652.37, selva: 4794.66}},
        {id: 66, name: "Escalera caracol metálica h=3.00m (entre pisos)", unit: "und", prices: {lima: 4291.51, costa: 4201.05, sierra: 4203.38, selva: 4331.95}},
        {id: 67, name: "Pastorales h=2.20m", unit: "und", prices: {lima: 519.47, costa: 508.52, sierra: 508.80, selva: 524.37}},
        {id: 68, name: "Proyector luminaria 250W vapor sodio", unit: "und", prices: {lima: 1054.39, costa: 1032.16, sierra: 1032.74, selva: 1064.32}},
        {id: 69, name: "Proyector luminaria 150W vapor mercurio", unit: "und", prices: {lima: 980.80, costa: 960.13, sierra: 960.66, selva: 990.04}},
        {id: 70, name: "Tubería concreto armado D=1.20m", unit: "ml", prices: {lima: 583.29, costa: 570.99, sierra: 571.31, selva: 588.78}},
        {id: 71, name: "Tubería concreto D=18\" (45cm)", unit: "ml", prices: {lima: 369.50, costa: 361.71, sierra: 361.91, selva: 372.98}},
        {id: 72, name: "Canaleta de concreto sin rejillas", unit: "ml", prices: {lima: 82.97, costa: 81.22, sierra: 81.27, selva: 83.75}},
        {id: 73, name: "Zanja concreto armado (talleres)", unit: "ml", prices: {lima: 926.72, costa: 907.19, sierra: 907.69, selva: 935.45}},
        {id: 74, name: "Poste concreto 12.00m + reflector", unit: "pza", prices: {lima: 5117.80, costa: 5009.92, sierra: 5012.70, selva: 5166.01}},
        {id: 75, name: "Poste concreto 11.00m + reflector", unit: "pza", prices: {lima: 4199.26, costa: 4110.74, sierra: 4113.02, selva: 4238.82}},
        {id: 76, name: "Poste concreto 10.00m + reflector", unit: "pza", prices: {lima: 3629.07, costa: 3552.58, sierra: 3554.55, selva: 3663.26}},
        {id: 77, name: "Poste concreto 9.00m + reflector", unit: "pza", prices: {lima: 3001.16, costa: 2937.90, sierra: 2939.53, selva: 3029.44}},
        {id: 78, name: "Poste concreto 8.00m + reflector", unit: "pza", prices: {lima: 2583.43, costa: 2528.97, sierra: 2530.37, selva: 2607.76}},
        {id: 79, name: "Poste concreto 7.00m + reflector", unit: "pza", prices: {lima: 2110.21, costa: 2065.73, sierra: 2066.88, selva: 2130.10}},
        {id: 80, name: "Poste concreto 3.00m + reflector", unit: "pza", prices: {lima: 964.46, costa: 944.13, sierra: 944.66, selva: 973.55}},
        {id: 81, name: "Cubierta tejas arcilla o similar", unit: "m2", prices: {lima: 134.24, costa: 140.27, sierra: 142.91, selva: 144.61}},
        {id: 82, name: "Cubierta ladrillo pastelero mezcla 1:5", unit: "m2", prices: {lima: 77.08, costa: 75.46, sierra: 75.50, selva: 77.81}},
        {id: 83, name: "Cubierta ladrillo pastelero barro", unit: "m2", prices: {lima: 73.84, costa: 72.28, sierra: 72.32, selva: 74.53}},
        {id: 84, name: "Cubierta torta de barro 2\"", unit: "m2", prices: {lima: 42.02, costa: 41.13, sierra: 41.16, selva: 42.42}},
        {id: 85, name: "Pasamano metálico tubo 3\"", unit: "ml", prices: {lima: 412.34, costa: 403.64, sierra: 403.87, selva: 416.22}},
        {id: 86, name: "Pasamano metálico tubo 2\"", unit: "ml", prices: {lima: 225.61, costa: 220.85, sierra: 220.98, selva: 227.74}},
        {id: 87, name: "Pasamano metálico tubo 1\"", unit: "ml", prices: {lima: 171.03, costa: 167.42, sierra: 167.52, selva: 172.64}},
        {id: 88, name: "Cerco metálico tubo 2\", malla #8", unit: "m2", prices: {lima: 242.15, costa: 237.04, sierra: 237.18, selva: 244.43}},
        {id: 89, name: "Cerco metálico tubo 2\", malla #10", unit: "m2", prices: {lima: 224.45, costa: 219.72, sierra: 219.84, selva: 226.56}},
        {id: 90, name: "Cerco metálico tubo 2\", malla #12", unit: "m2", prices: {lima: 201.44, costa: 197.19, sierra: 197.30, selva: 203.34}},
        {id: 91, name: "Poste/estructura fierro h=4m", unit: "pza", prices: {lima: 535.62, costa: 524.33, sierra: 524.62, selva: 540.66}},
        {id: 92, name: "Poste/estructura fierro h=2.50m", unit: "pza", prices: {lima: 313.28, costa: 306.68, sierra: 306.85, selva: 316.23}},
        {id: 93, name: "Sardinel concreto e=0.15m h=0.35 s/pintura", unit: "ml", prices: {lima: 128.50, costa: 125.79, sierra: 125.86, selva: 129.71}},
        {id: 94, name: "Sardinel concreto e=0.15m h=0.35 c/pintura", unit: "ml", prices: {lima: 141.17, costa: 138.19, sierra: 138.27, selva: 142.50}},
        {id: 95, name: "Pista o losa de concreto 6\"", unit: "m2", prices: {lima: 197.92, costa: 193.75, sierra: 193.86, selva: 199.78}},
        {id: 96, name: "Trampa de concreto armado para grasa", unit: "m3", prices: {lima: 1356.39, costa: 1327.80, sierra: 1328.54, selva: 1369.17}}
    ];

    const DEPRECIATION_TABLE = {
        'concreto': { 'muy_bueno': [0,5,10,15], 'bueno': [5,10,15,20], 'regular': [10,15,20,25], 'malo': [55,58,61,64] },
        'ladrillo': { 'muy_bueno': [0,3,6,9], 'bueno': [8,23,14,17], 'regular': [20,11,26,29], 'malo': [60,63,66,69] },
        'adobe':    { 'muy_bueno': [5,10,15,20], 'bueno': [30,20,25,30], 'regular': [15,35,40,45], 'malo': [65,70,75,80] }
    };

    const DATA_REGIONES = {
        'lima': {
            name: "Lima Metropolitana y Callao",
            components: [
                { id: 'muros', label: '1. Muros y Columnas', cats: [
                    {cat:'A', val:976.30, desc:'Estructuras laminares curvadas...'},
                    {cat:'B', val:629.46, desc:'Columnas/Vigas concreto...'},
                    {cat:'C', val:422.98, desc:'Placas concreto/Albañilería...'},
                    {cat:'D', val:409.04, desc:'Ladrillo sin concreto/Drywall...'},
                    {cat:'E', val:287.96, desc:'Adobe, Tapial o Quincha...'},
                    {cat:'F', val:222.15, desc:'Madera Estoraque, Pumaquiro...'},
                    {cat:'G', val:127.78, desc:'Pircado con mezcla de barro...'}
                ]},
                { id: 'techos', label: '2. Techos', cats: [
                    {cat:'A', val:592.97, desc:'Losa concreto > 6m luces...'},
                    {cat:'B', val:386.87, desc:'Aligerados inclinados...'},
                    {cat:'C', val:312.01, desc:'Aligerados horizontales...'},
                    {cat:'D', val:198.04, desc:'Calamina/Fibrocemento vigas met.'},
                    {cat:'E', val:73.83, desc:'Madera con impermeabilizante...'},
                    {cat:'F', val:41.60, desc:'Calamina/Fibrocemento vigas mad.'},
                    {cat:'G', val:27.91, desc:'Madera rústica o caña...'}
                ]},
                { id: 'pisos', label: '3. Pisos', cats: [
                    {cat:'A', val:529.84, desc:'Mármol, Porcelanato importado...'},
                    {cat:'B', val:279.28, desc:'Parquet fino, Cerámico alto tránsito...'},
                    {cat:'C', val:176.22, desc:'Cerámico nacional, Parquet común...'},
                    {cat:'D', val:154.35, desc:'Laminado, Vinílico...'},
                    {cat:'E', val:132.06, desc:'Cemento pulido...'},
                    {cat:'F', val:101.56, desc:'Madera corriente, Loseta...'},
                    {cat:'G', val:53.56, desc:'Cemento frotachado...'}
                ]},
                { id: 'puertas', label: '4. Puertas y Ventanas', cats: [
                    {cat:'A', val:529.84, desc:'Aluminio pesado, vidrio insulado...'},
                    {cat:'B', val:279.28, desc:'Aluminio diseño esp., vidrio templado...'},
                    {cat:'C', val:176.22, desc:'Aluminio/Madera fina, vidrio tratado...'},
                    {cat:'D', val:154.35, desc:'Aluminio standard, vidrio transp...'},
                    {cat:'E', val:132.06, desc:'Fierro, vidrio simple...'},
                    {cat:'F', val:101.56, desc:'Madera corriente, marcos PVC...'},
                    {cat:'G', val:53.56, desc:'Madera rústica...'}
                ]}
            ]
        },
        'costa': {
            name: "Costa (Excl. Lima)",
            components: [
                { id: 'muros', label: '1. Muros y Columnas', cats: [
                    {cat:'A', val:894.27, desc:'Estructuras laminares...'},
                    {cat:'B', val:576.57, desc:'Columnas/Vigas concreto...'},
                    {cat:'C', val:387.43, desc:'Placas concreto...'},
                    {cat:'D', val:374.68, desc:'Ladrillo sin concreto...'},
                    {cat:'E', val:263.77, desc:'Adobe/Tapial...'},
                    {cat:'F', val:198.64, desc:'Madera Estoraque...'},
                    {cat:'G', val:117.05, desc:'Pircado...'}
                ]},
                { id: 'techos', label: '2. Techos', cats: [
                    {cat:'A', val:543.16, desc:'Losa concreto > 6m...'},
                    {cat:'B', val:354.37, desc:'Aligerados inclinados...'},
                    {cat:'C', val:285.80, desc:'Aligerados horizontales...'},
                    {cat:'D', val:181.40, desc:'Calamina/Fibrocemento...'},
                    {cat:'E', val:67.63, desc:'Madera impermeabilizante...'},
                    {cat:'F', val:37.19, desc:'Calamina vigas madera...'},
                    {cat:'G', val:25.57, desc:'Madera rústica...'}
                ]},
                { id: 'pisos', label: '3. Pisos (Ref Col 3)', cats: [
                    {cat:'A', val:485.33, desc:'Mármol...'},
                    {cat:'B', val:255.81, desc:'Parquet fino...'},
                    {cat:'C', val:161.41, desc:'Cerámico...'},
                    {cat:'D', val:141.39, desc:'Laminado...'},
                    {cat:'E', val:120.98, desc:'Cemento...'},
                    {cat:'F', val:90.81, desc:'Madera corriente...'},
                    {cat:'G', val:49.05, desc:'Cemento frotachado...'}
                ]},
                 { id: 'puertas', label: '4. Puertas y Ventanas', cats: [
                    {cat:'A', val:485.33, desc:'Aluminio pesado...'},
                    {cat:'B', val:255.81, desc:'Vidrio templado...'},
                    {cat:'C', val:161.41, desc:'Vidrio tratado...'},
                    {cat:'D', val:141.39, desc:'Vidrio simple...'},
                    {cat:'E', val:120.98, desc:'Fierro...'},
                    {cat:'F', val:90.81, desc:'Madera corriente...'},
                    {cat:'G', val:49.05, desc:'Madera rústica...'}
                ]}
            ]
        },
        'sierra': {
            name: "Sierra",
            components: [
                { id: 'muros', label: '1. Muros y Columnas', cats: [
                    {cat:'A', val:1010.95, desc:'Estructuras laminares...'},
                    {cat:'B', val:601.44, desc:'Columnas/Vigas...'},
                    {cat:'C', val:425.98, desc:'Placas...'},
                    {cat:'D', val:393.47, desc:'Ladrillo...'},
                    {cat:'E', val:308.89, desc:'Adobe...'},
                    {cat:'F', val:192.61, desc:'Madera...'},
                    {cat:'G', val:113.49, desc:'Pircado...'}
                ]},
                { id: 'techos', label: '2. Techos', cats: [
                    {cat:'A', val:525.66, desc:'Losa...'},
                    {cat:'B', val:361.40, desc:'Aligerado inclinado...'},
                    {cat:'C', val:246.87, desc:'Aligerado horizontal...'},
                    {cat:'D', val:251.48, desc:'Calamina...'},
                    {cat:'E', val:76.73, desc:'Madera...'},
                    {cat:'F', val:61.30, desc:'Calamina vigas madera...'},
                    {cat:'G', val:0.00, desc:'Sin techo...'}
                ]},
                { id: 'pisos', label: '3. Pisos (Ref Col 3)', cats: [
                    {cat:'A', val:399.00, desc:'Mármol...'},
                    {cat:'B', val:353.08, desc:'Parquet...'},
                    {cat:'C', val:147.50, desc:'Cerámico...'},
                    {cat:'D', val:112.67, desc:'Laminado...'},
                    {cat:'E', val:87.12, desc:'Cemento...'},
                    {cat:'F', val:51.34, desc:'Madera corriente...'},
                    {cat:'G', val:25.67, desc:'Madera rústica...'}
                ]},
                 { id: 'puertas', label: '4. Puertas y Ventanas', cats: [
                    {cat:'A', val:399.00, desc:'Aluminio pesado...'},
                    {cat:'B', val:353.08, desc:'Vidrio templado...'},
                    {cat:'C', val:147.50, desc:'Vidrio tratado...'},
                    {cat:'D', val:112.67, desc:'Vidrio simple...'},
                    {cat:'E', val:87.12, desc:'Fierro...'},
                    {cat:'F', val:51.34, desc:'Madera corriente...'},
                    {cat:'G', val:25.67, desc:'Sin puertas...'}
                ]}
            ]
        },
        'selva': {
            name: "Selva",
            components: [
                 { id: 'muros', label: '1. Muros y Columnas', cats: [
                    {cat:'A', val:995.50, desc:'Estructuras laminares...'},
                    {cat:'B', val:679.21, desc:'Columnas/Vigas...'},
                    {cat:'C', val:489.75, desc:'Placas...'},
                    {cat:'D', val:378.67, desc:'Ladrillo...'},
                    {cat:'E', val:300.68, desc:'Madera selecta/Pilotes...'},
                    {cat:'F', val:205.37, desc:'Madera corriente...'},
                    {cat:'G', val:102.68, desc:'Madera rústica...'},
                    {cat:'H', val:41.08, desc:'Caña Guayaquil...'}
                ]},
                { id: 'techos', label: '2. Techos', cats: [
                    {cat:'A', val:509.83, desc:'Losa...'},
                    {cat:'B', val:360.15, desc:'Inclinado...'},
                    {cat:'C', val:265.25, desc:'Horizontal...'},
                    {cat:'D', val:231.25, desc:'Calamina...'},
                    {cat:'E', val:168.37, desc:'Madera tratada...'},
                    {cat:'F', val:60.91, desc:'Calamina vigas madera...'},
                    {cat:'G', val:77.41, desc:'Techos de palmas...'}
                ]},
                { id: 'pisos', label: '3. Pisos (Ref Col 3)', cats: [
                    {cat:'A', val:421.72, desc:'Mármol...'},
                    {cat:'B', val:334.51, desc:'Parquet...'},
                    {cat:'C', val:248.79, desc:'Cerámico...'},
                    {cat:'D', val:166.76, desc:'Laminado...'},
                    {cat:'E', val:108.28, desc:'Cemento...'},
                    {cat:'F', val:88.32, desc:'Madera corriente...'},
                    {cat:'G', val:52.11, desc:'Madera rústica...'}
                ]},
                 { id: 'puertas', label: '4. Puertas y Ventanas', cats: [
                    {cat:'A', val:421.72, desc:'Aluminio pesado...'},
                    {cat:'B', val:334.51, desc:'Vidrio templado...'},
                    {cat:'C', val:248.79, desc:'Vidrio tratado...'},
                    {cat:'D', val:166.76, desc:'Vidrio simple...'},
                    {cat:'E', val:108.28, desc:'Fierro...'},
                    {cat:'F', val:88.32, desc:'Madera corriente...'},
                    {cat:'G', val:52.11, desc:'Madera rústica...'}
                ]}
            ]
        }
    };

    // --- 2. CONFIGURACIÓN DEL MAPA ---
    const map = L.map("map", { zoomControl: false }).setView([-9.19, -75.0152], 6);
    // Control de zoom arriba a la derecha en móvil para no tapar el panel
    L.control.zoom({ position: 'topright' }).addTo(map);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; Lab Urban Risk',
        subdomains: 'abcd',
        maxZoom: 20
    }).addTo(map);

    // --- 3. LÓGICA CALCULADORA ---
    let currentObras = [];

    function init() {
        const hasSaved = loadState();
        if(!hasSaved) {
            updateRegion(); // Estado inicial por defecto
        } else {
            // Restaurar visualmente
            updateRegion(false); // false = no resetear categorías
            renderObrasList();
            // Ya no calculamos automáticamente al inicio, solo restauramos valores
        }
        
        // Mobile panel logic check
        if(window.innerWidth < 768) {
             togglePanel(false); // Empezar cerrado en móvil para ver mapa
        }
    }

    function updateRegion(resetCats = true) {
        const regionKey = document.getElementById('regionSelect').value;
        const data = DATA_REGIONES[regionKey];
        
        // 1. Renderizar Categorías
        const container = document.getElementById('categoriesContainer');
        container.innerHTML = '';
        
        data.components.forEach(comp => {
            let html = `
                <div class="bg-slate-50 p-2 rounded-lg border border-slate-200">
                    <div class="text-xs font-bold text-slate-600 mb-1">${comp.label}</div>
                    <select class="category-select w-full p-2 text-sm border rounded bg-white h-10">
                        <option value="0" data-val="0">-- Seleccionar --</option>
            `;
            
            comp.cats.forEach(cat => {
                html += `<option value="${cat.cat}" data-val="${cat.val}">Cat. ${cat.cat} - S/. ${cat.val.toFixed(2)}</option>`;
            });
            
            html += `</select></div>`;
            container.innerHTML += html;
        });

        // 2. Renderizar Obras Compl. Disponibles
        const obrasSelect = document.getElementById('obrasSelect');
        obrasSelect.innerHTML = '<option value="">-- Seleccionar obra(s) y/o instalación(es) --</option>';
        
        MASTER_OBRAS_LIST.forEach(obra => {
            const price = obra.prices[regionKey] || 0;
            obrasSelect.innerHTML += `<option value="${obra.id}" data-val="${price}" data-name="${obra.name}" data-unit="${obra.unit}">${obra.name}</option>`;
        });

        // 3. Highlight Mapa
        if(geojson) {
            geojson.eachLayer(layer => {
                layer.setStyle(style(layer.feature));
            });
        }
        
        // Reset categories if requested (new region)
        // Eliminado cálculo automático aquí
        saveState();
    }

    function getDepreciationPct(material, state, age) {
        let intervalIndex = Math.floor(age / 5);
        if (intervalIndex > 3) intervalIndex = 3;
        
        const matKey = material;
        const stateKey = state;
        
        if (!DEPRECIATION_TABLE[matKey]) return 0;
        const percentages = DEPRECIATION_TABLE[matKey][stateKey];
        if (!percentages) return 0;
        if (intervalIndex >= percentages.length) return percentages[percentages.length-1];
        return percentages[intervalIndex];
    }

    function calculate() {
        // 1. Calcular Valor Unitario Total (Categorías)
        let totalUnitario = 0;
        document.querySelectorAll('.category-select').forEach(sel => {
            const opt = sel.options[sel.selectedIndex];
            totalUnitario += parseFloat(opt.getAttribute('data-val') || 0);
        });
        document.getElementById('valorUnitarioTotal').innerText = totalUnitario.toFixed(2);

        // 2. Calcular Depreciación
        const mat = document.getElementById('materialSelect').value;
        const est = document.getElementById('estadoSelect').value;
        const age = parseInt(document.getElementById('antiguedadInput').value) || 0;
        
        const deprecPct = getDepreciationPct(mat, est, age);
        document.getElementById('deprecDisplay').innerText = deprecPct + "%";
        const factorDepreciacion = 1 - (deprecPct / 100);

        // 3. Subtotal 1: Valor Edificación (Base)
        const area = parseFloat(document.getElementById('areaInput').value) || 0;
        const subtotal1 = totalUnitario * area * factorDepreciacion;
        document.getElementById('subtotalEdif').innerText = "S/. " + subtotal1.toLocaleString('es-PE', {minimumFractionDigits: 2});

        // 4. Subtotal 2: Obras Complementarias
        let subtotal2 = 0;
        currentObras.forEach(o => subtotal2 += o.total);
        document.getElementById('subtotalObras').innerText = "S/. " + subtotal2.toLocaleString('es-PE', {minimumFractionDigits: 2});

        // 5. Total Valor Edificación (Suma de Subtotales)
        const totalEdificacion = subtotal1 + subtotal2;
        document.getElementById('totalFinal').innerText = "S/. " + totalEdificacion.toLocaleString('es-PE', {minimumFractionDigits: 2});
        
        // Actualizar visualización automática en sección Predio
        document.getElementById('displayEdificacionAuto').innerText = "S/. " + totalEdificacion.toLocaleString('es-PE', {minimumFractionDigits: 2});

        // 6. Recalcular Predio si hay valor de terreno
        calculatePredio(totalEdificacion);

        saveState();
    }

    function calculatePredio(totalEdif) {
        // Si no se pasa el total, obtenerlo del DOM
        let valEdificacion = totalEdif;
        if (typeof valEdificacion === 'undefined') {
             // Limpiar formato S/. y comas para obtener número limpio
             const text = document.getElementById('totalFinal').innerText.replace('S/. ', '').replace(/,/g, '');
             valEdificacion = parseFloat(text) || 0;
        }

        const valTerreno = parseFloat(document.getElementById('valorTerrenoInput').value) || 0;
        const valPredio = valEdificacion + valTerreno;
        
        document.getElementById('valorPredioTotal').innerText = "S/. " + valPredio.toLocaleString('es-PE', {minimumFractionDigits: 2});
        
        saveState();
    }

    function addObra() {
        const sel = document.getElementById('obrasSelect');
        const opt = sel.options[sel.selectedIndex];
        if(!opt.value) return;

        const qty = parseFloat(document.getElementById('obraQty').value) || 0;
        if(qty <= 0) return;

        const val = parseFloat(opt.getAttribute('data-val'));
        const name = opt.getAttribute('data-name');
        const unit = opt.getAttribute('data-unit');

        currentObras.push({
            id: Date.now(),
            name: name,
            qty: qty,
            unit: unit,
            val: val,
            total: val * qty
        });

        renderObrasList();
        // Eliminado calculate() automático al añadir obra
        
        document.getElementById('obraQty').value = '';
        sel.value = "";
    }

    function removeObra(id) {
        currentObras = currentObras.filter(o => o.id !== id);
        renderObrasList();
        // Eliminado calculate() automático al borrar obra
    }

    function renderObrasList() {
        const list = document.getElementById('obrasList');
        if (currentObras.length === 0) {
            list.innerHTML = '<div class="text-center py-4 text-xs text-slate-400 italic" id="emptyObrasMsg">Sin obras adicionales</div>';
            return;
        }

        list.innerHTML = '';
        currentObras.forEach(o => {
            list.innerHTML += `
                <div class="flex justify-between items-center bg-white p-2 rounded-lg border border-slate-200 text-xs mb-1 last:mb-0 shadow-sm">
                    <div>
                        <div class="font-bold text-slate-700 w-40 truncate" title="${o.name}">${o.name}</div>
                        <div class="text-slate-500">${o.qty} ${o.unit} x S/.${o.val.toFixed(2)}</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="font-bold text-blue-700">S/.${o.total.toFixed(0)}</span>
                        <button onclick="removeObra(${o.id})" class="text-red-400 hover:text-red-600 p-2 bg-red-50 rounded"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            `;
        });
    }

    function resetCalculator() {
        if(confirm("¿Reiniciar calculadora?")) {
            localStorage.removeItem('calcState');
            document.getElementById('antiguedadInput').value = 0;
            document.getElementById('areaInput').value = 100;
            document.getElementById('materialSelect').selectedIndex = 0;
            document.getElementById('estadoSelect').selectedIndex = 0;
            document.getElementById('valorTerrenoInput').value = ''; 
            currentObras = [];
            renderObrasList();
            updateRegion();
            // Reset results display manually
            document.getElementById('subtotalEdif').innerText = "S/. 0.00";
            document.getElementById('subtotalObras').innerText = "S/. 0.00";
            document.getElementById('totalFinal').innerText = "S/. 0.00";
            document.getElementById('displayEdificacionAuto').innerText = "0.00";
            document.getElementById('valorPredioTotal').innerText = "S/. 0.00";
        }
    }

    // --- UI TOGGLE ---
    const toggleBtn = document.getElementById('toggleSideBtn');
    const mobileToggleBtn = document.getElementById('mobileToggleBtn');
    const mainPanel = document.getElementById('mainPanel');
    const uiContainer = document.getElementById('uiContainer');
    let isOpen = true;

    function togglePanel(forceState) {
        if (typeof forceState === 'boolean') isOpen = !forceState; // Invert to toggle correctly
        
        isOpen = !isOpen;
        if(isOpen) {
            mainPanel.classList.remove('panel-hidden');
            mainPanel.classList.add('panel-visible');
            toggleBtn.querySelector('i').className = "fa-solid fa-chevron-left text-lg";
            uiContainer.classList.remove('pointer-events-none');
        } else {
            mainPanel.classList.remove('panel-visible');
            mainPanel.classList.add('panel-hidden');
            toggleBtn.querySelector('i').className = "fa-solid fa-chevron-right text-lg";
            uiContainer.classList.add('pointer-events-none');
        }
    }

    toggleBtn.addEventListener('click', () => togglePanel());
    mobileToggleBtn.addEventListener('click', () => togglePanel());

    // --- 4. MAPA: ESTILOS Y SELECCIÓN ---
    let selectedLayer = null;

    function style(feature) {
      const ubigeo = feature.properties.ubigeo || feature.properties.UBIGEO || "";
      const region = detectRegion(ubigeo);
      const selectedRegion = document.getElementById('regionSelect') ? document.getElementById('regionSelect').value : 'lima';
      const isActive = region === selectedRegion;

      return {
        color: isActive ? "#2563eb" : "#94a3b8",
        weight: isActive ? 1.5 : 0.5, 
        opacity: 1,
        fillColor: isActive ? "#3b82f6" : "#cbd5e1",
        fillOpacity: isActive ? 0.4 : 0.1
      };
    }

    function highlightStyle() {
        return { weight: 2, color: '#0047FF', fillColor: '#0047FF', fillOpacity: 0.8 };
    }

    function resetHighlight(e) {
      if (e.target !== selectedLayer) {
        const layer = e.target;
        layer.setStyle(style(layer.feature));
      }
    }

    function highlightFeature(e) {
      const layer = e.target;
      if (layer !== selectedLayer) {
          layer.setStyle(highlightStyle());
          if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) layer.bringToFront();
      }
    }

    function detectRegion(ubigeo) {
        if (!ubigeo) return 'costa'; 
        const dep = ubigeo.substring(0, 2);
        if (dep === '15' || dep === '07') return 'lima';
        if (['16', '17', '25', '01', '22'].includes(dep)) return 'selva';
        if (['08', '21', '03', '05', '09', '10', '12', '19', '06'].includes(dep)) return 'sierra';
        return 'costa';
    }

    function selectFeature(layer) {
        if (selectedLayer && selectedLayer !== layer) {
             const prevLayer = selectedLayer;
             selectedLayer = null; 
             prevLayer.setStyle(style(prevLayer.feature));
        }
        
        selectedLayer = layer;
        layer.setStyle(highlightStyle());
        layer.bringToFront();
        
        map.flyToBounds(layer.getBounds(), { padding: [20, 20], maxZoom: 13, duration: 1.2 });
        
        const props = layer.feature.properties;
        const distName = props.distrito || props.NOMBDIST || "Distrito Seleccionado";
        const ubigeo = props.ubigeo || props.UBIGEO || "";
        const detectedRegion = detectRegion(ubigeo);
        
        document.getElementById('regionSelect').value = detectedRegion;
        document.getElementById('selectedDistrictDisplay').innerHTML = `<i class="fa-solid fa-location-dot mr-1"></i> ${distName} (${detectedRegion.toUpperCase()})`;
        
        updateRegion(true); // Actualiza y resetea categorías
        
        // En móvil, abrir panel para mostrar cálculo
        if(window.innerWidth < 768) {
             togglePanel(true);
        }
    }

    function onEachFeature(feature, layer) {
      layer.on({
        mouseover: highlightFeature,
        mouseout: resetHighlight,
        click: (e) => {
            L.DomEvent.stopPropagation(e);
            selectFeature(layer);
        }
      });
    }

    let geojson;
    
    fetch("distritos_mef_2026_con_zip.geojson")
      .then(r => { if (!r.ok) throw new Error("Err"); return r.json(); })
      .then(data => {
        geojson = L.geoJSON(data, { style, onEachFeature }).addTo(map);
        map.fitBounds(geojson.getBounds());
      })
      .catch(err => {
        console.warn("Modo Demo");
        const mockData = { "type": "FeatureCollection", "features": [
                { "type": "Feature", "properties": { "distrito": "LIMA", "ubigeo": "150101" }, "geometry": { "type": "Polygon", "coordinates": [[[-77.045, -12.045], [-77.025, -12.045], [-77.025, -12.065], [-77.045, -12.065], [-77.045, -12.045]]] } },
                { "type": "Feature", "properties": { "distrito": "TRUJILLO", "ubigeo": "130101" }, "geometry": { "type": "Polygon", "coordinates": [[[-79.05, -8.10], [-78.95, -8.10], [-78.95, -8.15], [-79.05, -8.15], [-79.05, -8.10]]] } },
                { "type": "Feature", "properties": { "distrito": "CUSCO", "ubigeo": "080101" }, "geometry": { "type": "Polygon", "coordinates": [[[-72.00, -13.50], [-71.90, -13.50], [-71.90, -13.55], [-72.00, -13.55], [-72.00, -13.50]]] } },
                { "type": "Feature", "properties": { "distrito": "IQUITOS", "ubigeo": "160101" }, "geometry": { "type": "Polygon", "coordinates": [[[-73.25, -3.70], [-73.15, -3.70], [-73.15, -3.80], [-73.25, -3.80], [-73.25, -3.70]]] } }
        ]};
        geojson = L.geoJSON(mockData, { style, onEachFeature }).addTo(map);
        map.setView([-9.19, -75.0152], 5);
      });

    init();
  </script>
</body>
</html>
